---
layout: post
title: Decorators without the Magic
description: "Decorators look like magic when you first see them, but they don’t feel like something mere mortals could write. We’ll go through some examples of exactly how they work (without the scary <code>@</code> syntax), and why they are a nice pattern for writing elegant, easy to understand code."
category: blog
mathjax: true
tags: [programming, python, decorators]
feature_image: pollock.jpg
lighten_text: true
darken_image: 0.2
---

<div class="ipynb">
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<p>Decorators look like magic when you first see them, but they don’t feel like something mere mortals could write. We’ll go through some examples of exactly how they work (without the scary ‘@‘ syntax), and why they are a nice pattern for writing elegant, easy to understand code.</p>
<p>The following is adapted from a talk I gave at STL Python on January 6, 2015.</p>
<p>We need some code to work with, so let's go with something familiar. The recusive definition of fibonacci numbers should be familiar to most coders.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [1]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Give the nth fibonacci number.</span>
<span class="sd">    </span>
<span class="sd">    This code runs in O(2^n) time, for illustration purposes"""</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try out a few test cases, to see how the performance is.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [2]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">ix</span><span class="p">,</span> <span class="n">fib</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
0 0
1 1
2 1
3 2
4 3
5 5
6 8
7 13
8 21
9 34

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [3]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">fib</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 5.14 ms, sys: 1.67 ms, total: 6.82 ms
Wall time: 5.46 ms

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[3]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
6765
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [4]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">fib</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 497 ms, sys: 19.2 ms, total: 516 ms
Wall time: 503 ms

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[4]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
832040
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [5]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">fib</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 5.04 s, sys: 14.6 ms, total: 5.05 s
Wall time: 5.1 s

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[5]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
9227465
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Five seconds and we're only at <code>n=1</code>! This is not going to cut it. The reason (as you may already know), is that we're repeating a lot of work. For example, <code>fib(5)</code> calls <code>fib(4)</code> and <code>fib(3)</code>, but because we don't save <code>fib(3)</code>, we have to compute it again when <code>fib(4)</code> needs it. This gives us a runtime of $O(2^n)$, very slow.</p>
<p>Rather than re-compute all that work, let's save the results. <code>fib(3)</code> is going to be <code>2</code> no matter who asks, so we can save the number each time. This is called 'memoization'.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [6]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">fib_table</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#somewhere to store the answers we've already computed</span>

<span class="k">def</span> <span class="nf">memo_fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Give the nth fibonacci number.</span>
<span class="sd">    </span>
<span class="sd">    This code is much faster than before."""</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">fib_table</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fib_table</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">memo_fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">memo_fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fib_table</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span> <span class="c">#make sure to save this for the next call</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's see how the runtime compares with our unmemoized version.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [7]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memo_fib</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 25 µs, sys: 20 µs, total: 45 µs
Wall time: 38.1 µs

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[7]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
6765
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [8]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memo_fib</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 17 µs, sys: 9 µs, total: 26 µs
Wall time: 22.9 µs

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[8]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
832040
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [9]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memo_fib</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 11 µs, sys: 5 µs, total: 16 µs
Wall time: 16.9 µs

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[9]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
9227465
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [10]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memo_fib</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 424 µs, sys: 297 µs, total: 721 µs
Wall time: 544 µs

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[10]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
6254449428820551641549772190170184190608177514674331726439961915653414425L
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [11]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memo_fib</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 1.12 ms, sys: 550 µs, total: 1.67 ms
Wall time: 1.36 ms

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[11]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
43466557686937456435688527675040625802564660517371780402481729089536555417949051890403879840079255169295922593080322634775209689623239873322471161642996440906533187938298969649928516003704476137795166849228875L
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Whoa, what a change! In fact, memoization brings the runtime down to $O(n)$, much better than $O(2^n)$.</p>
<p>We might want to use memoization on other occasions. Decorators can help us with this.</p>
<p>What is the memoization pattern? Basically you keep a dictionary of the results of each call. When we make a new call to the function, first check if it's in our table of saved results. If we <em>do</em> have to do work, save the answer for next time.</p>
<p>Here's the punchline: we can factor out this idea, and make a <code>memoized</code> higher-order function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [12]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">memoized</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">"""Given a function of one argument,</span>
<span class="sd">    return a memoized version of that function.</span>
<span class="sd">    """</span>
    <span class="n">lookup_table</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">memoized_version</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">lookup_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lookup_table</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="n">lookup_table</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">memoized_version</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Okay, let's test this out on a function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [13]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">"""Print out a personalized greeting.</span>
<span class="sd">    </span>
<span class="sd">    (personalization takes time).</span>
<span class="sd">    """</span>
    <span class="k">print</span> <span class="s">'hold on, let me think...'</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'Hi there, {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [14]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Brian'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hold on, let me think...
CPU times: user 329 µs, sys: 518 µs, total: 847 µs
Wall time: 2.01 s

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[14]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Hi there, Brian&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [15]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Dan'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hold on, let me think...
CPU times: user 409 µs, sys: 688 µs, total: 1.1 ms
Wall time: 2.01 s

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[15]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Hi there, Dan&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [16]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">memoized_greet</span> <span class="o">=</span> <span class="n">memoized</span><span class="p">(</span><span class="n">greet</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [17]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memoized_greet</span><span class="p">(</span><span class="s">'Dan'</span><span class="p">)</span> <span class="c"># The first call is still slow</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hold on, let me think...
CPU times: user 361 µs, sys: 536 µs, total: 897 µs
Wall time: 2 s

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[17]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Hi there, Dan&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [18]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">memoized_greet</span><span class="p">(</span><span class="s">'Dan'</span><span class="p">)</span> <span class="c"># Subsequent calls are quick!</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 3 µs, sys: 0 ns, total: 3 µs
Wall time: 7.15 µs

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[18]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Hi there, Dan&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So memoization is great, but I don't really want to have two versions of my function around. Let's overwrite the original and just always use memoization.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [19]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">greet</span> <span class="o">=</span> <span class="n">memoized</span><span class="p">(</span><span class="n">greet</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [20]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Dan'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hold on, let me think...
CPU times: user 347 µs, sys: 534 µs, total: 881 µs
Wall time: 2.01 s

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[20]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Hi there, Dan&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [21]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="o">%</span><span class="k">time</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Dan'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
CPU times: user 4 µs, sys: 2 µs, total: 6 µs
Wall time: 7.87 µs

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[21]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Hi there, Dan&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Remember our slow $O(2^n)$ implementation of fibonacci from above? We can memoize it <em>with no code changes</em>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [22]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">fib</span> <span class="o">=</span> <span class="n">memoized</span><span class="p">(</span><span class="n">fib</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [23]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">fib</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[23]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
12586269025
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [24]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">fib</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[24]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
280571172992510140037611932413038677189525L
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [25]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">fib</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[25]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
139423224561697880139724382870407283950070256587697307264108962948325571622863290691557658876222521294125L
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [26]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">fib</span><span class="p">(</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[26]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
69283081864224717136290077681328518273399124385204820718966040597691435587278383112277161967532530675374170857404743017623467220361778016172106855838975759985190398725L
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And actually, that's decorators. That's exactly what decorators do. They overwrite a function with a modified version of the same function. So we could have written greet this way:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [27]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@memoized</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">"""Print out a personalized greeting.</span>
<span class="sd">    </span>
<span class="sd">    (personalization takes time)."""</span>
    <span class="k">print</span> <span class="s">'hold on, let me think...'</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'Hi there, {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="c"># Exactly the same as...</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">"""Print out a personalized greeting.</span>
<span class="sd">    </span>
<span class="sd">    (personalization takes time)."""</span>
    <span class="k">print</span> <span class="s">'hold on, let me think...'</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'Hi there, {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="n">greet</span> <span class="o">=</span> <span class="n">memoized</span><span class="p">(</span><span class="n">greet</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [28]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@memoized</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Give the nth fibonacci number.</span>
<span class="sd">    </span>
<span class="sd">    Because of memoization, this code runs in O(n) time</span>
<span class="sd">    (but it still might blow your stack)"""</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

<span class="c"># Exactly the same as...</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Give the nth fibonacci number.</span>
<span class="sd">    </span>
<span class="sd">    Because of memoization, this code runs in O(n) time</span>
<span class="sd">    (but it still might blow your stack)"""</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">fib</span> <span class="o">=</span>  <span class="n">memoized</span><span class="p">(</span><span class="n">fib</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Okay, that's cool, but let's see another example. Say we wanted to time the execution of a function. Decorators allow us to write code that runs before and after the regular function, so this shouldn't be too bad. We'll need some code to time, so let's use a prime checker.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [29]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="c">#@timed  # This doesn't exist yet...</span>
<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">potential_divisor</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">potential_divisor</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">potential_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">potential_divisor</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [30]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">is_prime</span><span class="p">(</span><span class="mi">618</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[30]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
False
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [31]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">timed_version</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'that took'</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">timed_version</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we've written a definition for <code>timed</code>, we can use it in our definition of <code>is_prime</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [32]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@timed</span>
<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">potential_divisor</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">potential_divisor</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">potential_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">potential_divisor</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [33]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">is_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
that took 0:00:00.013842

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[33]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
True
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So that's great, but we swept a small detail under the rug. This will only work for functions of a single parameter (called n)! When we wrote our <code>timed_version</code>, we assumed it would accept <code>n</code> as its only parameter. </p>
<p>This seems like a violation of reuse — our timing decorator should be general. It shouldn't work only for functions with parameter, let alone functions with one parameter called <code>n</code>.</p>
<p>Suppose we wanted to change the parameters to <code>is_prime</code>, maybe also passing in <code>give_factors</code>, like this:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [34]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@timed</span>
<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">give_factors</span><span class="p">):</span>
    <span class="sd">"""Determine whether a number is prime.</span>
<span class="sd">      num - the possibly prime number</span>
<span class="sd">      give_factors - True/False, whether to include the factors</span>
<span class="sd">    """</span>
      
    <span class="n">potential_divisor</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">potential_divisor</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">num</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="n">potential_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">potential_divisor</span><span class="p">,</span> <span class="n">num</span> <span class="o">/</span> <span class="n">potential_divisor</span><span class="p">))</span>
        <span class="n">potential_divisor</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">num_is_prime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">give_factors</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num_is_prime</span><span class="p">,</span> <span class="n">factors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num_is_prime</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [36]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">is_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># This will crash because</span>
<span class="c"># timed_version is expecting only a single parameter</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_text output_pyerr">
<pre>
<span class="ansired">---------------------------------------------------------------------------</span>
<span class="ansired">TypeError</span>                                 Traceback (most recent call last)
<span class="ansigreen">&lt;ipython-input-36-a7edfb41034e&gt;</span> in <span class="ansicyan">&lt;module&gt;</span><span class="ansiblue">()</span>
<span class="ansigreen">----&gt; 1</span><span class="ansired"> </span>is_prime<span class="ansiblue">(</span><span class="ansicyan">2</span><span class="ansiblue">**</span><span class="ansicyan">31</span> <span class="ansiblue">-</span> <span class="ansicyan">1</span><span class="ansiblue">,</span> True<span class="ansiblue">)</span> <span class="ansired"># This will crash because</span><span class="ansiblue"></span>
<span class="ansigreen">      2</span> <span class="ansired"># timed_version is expecting only a single parameter</span><span class="ansiblue"></span><span class="ansiblue"></span>

<span class="ansired">TypeError</span>: timed_version() takes exactly 1 argument (2 given)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll rewrite this in a moment to be more general, but first, we have to talk about another confusing aspect of python — star-args</p>
<h2 id="-args-kwargs-"><code>*args, **kwargs</code></h2>
<p><code>*args</code> and <code>**kwargs</code> are the packing/unpacking operators. A single <code>*</code> is used to turn a list to/from a series of positional parameters. A double <code>**</code> does the same, but for dictionaries and keyword arguments.</p>
<p>Let's do an example.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [37]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [38]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">operands</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">operands</span><span class="p">)</span> <span class="c"># --&gt; add(operands[0], operands[1])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[38]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
7
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>*operands</code> gets turned into a series of positional parameters, one for each item in <code>operands</code>.</p>
<p>What if we use the <code>*</code> in the function definition?</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [39]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">addend</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">addend</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This new version of <code>add</code> accepts any number of parameters. They all packed into the <code>args</code> variable.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [40]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[40]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
15
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Suppose we wanted to use both packing and unpacking? We can!
<code>*operands</code> here will be unpacked to make a positional argument for each element of the list <code>operands</code>. Then, in the body of the <code>add</code> function, the positional arguments have all been packed into a single variable, <code>args</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [41]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">operands</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">operands</span><span class="p">)</span> <span class="c"># --&gt; add(operands[0], operands[1], ..., operands[4])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[41]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
15
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So that's packing and unpacking for positional parameters. What about keyword parameters? We'll use the following function for illustration.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [42]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">birthday</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'Happy Birthday, {}! congrats on number {}.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [43]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Batman'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">31</span><span class="p">}</span>
<span class="k">print</span> <span class="n">birthday</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="c"># --&gt; birthday(name='Batman', age=31)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
Happy Birthday, Batman! congrats on number 31.

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>the <code>params</code> dictionary gets unpacked into keyword args and passed into birthday. </p>
<p>This can be useful if we have a whole list of folks we want to wish a Happy Birthday:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [44]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">birthday_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Robert'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
    <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Steven'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">26</span><span class="p">},</span>
    <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Cassie'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">39</span><span class="p">}</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">bday</span> <span class="ow">in</span> <span class="n">birthday_list</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">birthday</span><span class="p">(</span><span class="o">**</span><span class="n">bday</span><span class="p">)</span> <span class="c"># --&gt; birthday(name='Robert', age=12)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
Happy Birthday, Robert! congrats on number 12.
Happy Birthday, Steven! congrats on number 26.
Happy Birthday, Cassie! congrats on number 39.

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Just like with the positional parameters, there is a packing operator as well. In this case, we'll illustrate with a reimplementation of the new-style string format function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [45]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">strformat</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'{'</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s">'}'</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Any keyword parameters that are passed into the <code>strformat</code> function get packaged up into the <code>kwargs</code> dictionary. So <code>strformat</code> doesn't even need to know the names of the parameters you're going to use!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [46]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">strformat</span><span class="p">(</span><span class="s">'Happy {occasion}, {name}'</span><span class="p">,</span>
          <span class="n">occasion</span><span class="o">=</span><span class="s">'Thanksgiving'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Diane'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[46]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
&amp;apos;Happy Thanksgiving, Diane&amp;apos;
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Okay, excellent. So, <code>*args, **kwargs</code> let us work with functions that are really general.</p>
<p>This helps us with writing decorators because we want to be able to accept any set of parameters, without knowing or specifying them in advance. Let's revisit our <code>timed</code> decorator as an example.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [47]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">timed_version</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'that took'</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">timed_version</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Excellent. None of this "you must use a function with one parameter and it must be called <code>n</code>" business.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [48]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@timed</span>
<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">give_factors</span><span class="p">):</span>
    <span class="sd">"""Determine whether a number is prime.</span>
<span class="sd">      num - the possibly prime number</span>
<span class="sd">      give_factors - True/False, whether to include the factors</span>
<span class="sd">    """</span>
      
    <span class="n">potential_divisor</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">potential_divisor</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">num</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="n">potential_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">potential_divisor</span><span class="p">,</span> <span class="n">num</span> <span class="o">/</span> <span class="n">potential_divisor</span><span class="p">))</span>
        <span class="n">potential_divisor</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">num_is_prime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">give_factors</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num_is_prime</span><span class="p">,</span> <span class="n">factors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num_is_prime</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [49]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">is_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># This time it actually works!</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
that took 0:00:00.014745

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[49]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
(True, [])
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="more-examples">More examples</h2>
<p>We'll make a <code>cached</code> decorator, that remembers the result it computed, but only for a short time. We could do our fancy <code>*args, **kwargs</code> business, and make kind of a <code>cached_and_memoized</code> decorator, but let's keep it simple.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [50]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span> <span class="nf">cached</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">"""Given a function of no arguments, return a version</span>
<span class="sd">    that caches its value for ten seconds."""</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">cached_version</span><span class="p">():</span>
        <span class="k">if</span> <span class="s">'expiry'</span> <span class="ow">in</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">cache</span><span class="p">[</span><span class="s">'expiry'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
            <span class="n">cache</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">cache</span><span class="p">[</span><span class="s">'expiry'</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">cached_version</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now to use the decorator</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [51]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="nd">@cached</span>
<span class="k">def</span> <span class="nf">cat_picture</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">'hitting api'</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://edgecats.net/random'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll see if the cache is actually working. We'll run <code>cat_picture()</code> twice in a row, and we should see the same picture. Then, we'll sleep for 10 seconds and we should get a new picture.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [52]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">cat_picture</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hitting api

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[52]:</div>
<div class="output_html rendered_html output_subarea output_pyout">
<img src="http://moar.edgecats.net/cats/U2fyFkH.gif"/>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [53]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">cat_picture</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[53]:</div>
<div class="output_html rendered_html output_subarea output_pyout">
<img src="http://moar.edgecats.net/cats/U2fyFkH.gif"/>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [54]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cat_picture</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hitting api

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[54]:</div>
<div class="output_html rendered_html output_subarea output_pyout">
<img src="http://moar.edgecats.net/cats/k6VVRlh.gif"/>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Nice!</p>
<p>Let's say we wanted to make a more general <code>cached</code> decorator. We want be able to specify how long to wait before the cache is invalid.</p>
<p>This means we need one more layer of nesting. Basically, we need to write a function that returns the decorator. This is a bit complicated, so read this code carefully.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [55]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">cached</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""return a decorator that caches for the specified time."""</span>
    <span class="n">wait</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cached_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">"""Given a function of no arguments, return a version</span>
<span class="sd">        that caches its value for &lt;wait&gt; seconds."""</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">cached_version</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">'expiry'</span> <span class="ow">in</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">cache</span><span class="p">[</span><span class="s">'expiry'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
                <span class="n">cache</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">cache</span><span class="p">[</span><span class="s">'expiry'</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">wait</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">cached_version</span>
    <span class="k">return</span> <span class="n">cached_decorator</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can use this decorator like so:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [56]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@cached</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cat_picture</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">'hitting api'</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://edgecats.net/random'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>But hold on. This is starting to feel like magic again. Let's take apart that construction and see what it's really doing. We'll use our knowledge of what's really happening with that <code>@</code> sign.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [57]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">cat_picture</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">'hitting api'</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://edgecats.net/random'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">cat_picture</span> <span class="o">=</span> <span class="p">(</span><span class="n">cached</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">))(</span><span class="n">cat_picture</span><span class="p">)</span>

<span class="c"># Or, even clearer</span>

<span class="n">cached_for_two_seconds</span> <span class="o">=</span> <span class="n">cached</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c"># create our</span>
<span class="c"># decorator, setting the wait time</span>

<span class="k">def</span> <span class="nf">cat_picture</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">'hitting api'</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://edgecats.net/random'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">cat_picture</span> <span class="o">=</span> <span class="n">cached_for_two_seconds</span><span class="p">(</span><span class="n">cat_picture</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [58]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">cat_picture</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hitting api

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[58]:</div>
<div class="output_html rendered_html output_subarea output_pyout">
<img src="http://moar.edgecats.net/cats/130621-30.gif"/>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [59]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">cat_picture</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[59]:</div>
<div class="output_html rendered_html output_subarea output_pyout">
<img src="http://moar.edgecats.net/cats/130621-30.gif"/>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [60]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cat_picture</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
hitting api

</pre>
</div>
</div>
<div class="output_area"><div class="prompt output_prompt">
    Out[60]:</div>
<div class="output_html rendered_html output_subarea output_pyout">
<img src="http://moar.edgecats.net/cats/kitteh.gif"/>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="imitating-flask">Imitating Flask</h2>
<p><a href="http://flask.pocoo.org/">Flask</a> is an excellent web framework that registers its views using decorators. We can mimic this interface to understand how it works.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [61]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Tube</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""A Tube is a small Flask, right?"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">register_endpoint</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">register_endpoint</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [62]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Tube</span><span class="p">()</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/api/cat_picture'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_cat_pic</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'blah'</span>

<span class="c"># or, desugared</span>
<span class="n">route_to_dog_pic</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/api/doc_picture'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_dog_pic</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'slaw'</span>
<span class="n">get_dog_pic</span> <span class="o">=</span> <span class="n">route_to_dog_pic</span><span class="p">(</span><span class="n">get_dog_pic</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [63]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">endpoints</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt output_prompt">
    Out[63]:</div>
<div class="output_text output_subarea output_pyout">
<pre>
{&amp;apos;/api/cat_picture&amp;apos;: &lt;function __main__.get_cat_pic&gt;,
 &amp;apos;/api/doc_picture&amp;apos;: &lt;function __main__.get_dog_pic&gt;}
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="bonus-synchronization">Bonus: Synchronization</h2>
<p>Suppose you have multithreaded program, and you want to protect the critical section with a mutex so no two threads can be there at the same time. We can do this with a decorator!!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [64]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">threading</span>
<span class="k">def</span> <span class="nf">synchronized</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">critical_section</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">critical_section</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll use an example from <a href="http://en.wikipedia.org/wiki/Lord_of_the_Flies">Lord of the Flies</a> to illustrate what's going on. First, without synchronization.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [65]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="c">#@synchronized Let's do this first without</span>
<span class="k">def</span> <span class="nf">claim_speaking_priviledges</span><span class="p">(</span><span class="n">claimant</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"{}: I've got the conch!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">claimant</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">"{}: Okay, you can talk now."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">claimant</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [66]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">speakers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">speaker</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'Ralph'</span><span class="p">,</span> <span class="s">'Piggy'</span><span class="p">,</span> <span class="s">'Jack'</span><span class="p">,</span> <span class="s">'Roger'</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">claim_speaking_priviledges</span><span class="p">,</span>
                         <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'claimant'</span><span class="p">:</span><span class="n">speaker</span><span class="p">})</span>
    <span class="n">speakers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
Ralph: I&amp;apos;ve got the conch!
Piggy: I&amp;apos;ve got the conch!
Jack: I&amp;apos;ve got the conch!
Roger: I&amp;apos;ve got the conch!
Piggy: Okay, you can talk now.Roger: Okay, you can talk now.
 Jack: Okay, you can talk now.
Ralph: Okay, you can talk now.


</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [67]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="nd">@synchronized</span>
<span class="k">def</span> <span class="nf">claim_speaking_priviledges</span><span class="p">(</span><span class="n">claimant</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"{}: I've got the conch!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">claimant</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">"{}: Okay, you can talk now."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">claimant</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In [68]:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre><span class="n">speakers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">speaker</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'Ralph'</span><span class="p">,</span> <span class="s">'Piggy'</span><span class="p">,</span> <span class="s">'Jack'</span><span class="p">,</span> <span class="s">'Roger'</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">claim_speaking_priviledges</span><span class="p">,</span>
                         <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'claimant'</span><span class="p">:</span><span class="n">speaker</span><span class="p">})</span>
    <span class="n">speakers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
Ralph: I&amp;apos;ve got the conch!
Ralph: Okay, you can talk now.
Piggy: I&amp;apos;ve got the conch!
Piggy: Okay, you can talk now.
Jack: I&amp;apos;ve got the conch!
Jack: Okay, you can talk now.
Roger: I&amp;apos;ve got the conch!
Roger: Okay, you can talk now.

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Much more orderly.</p>
<p>Hopefully this illustrates the power of decorators, and lessens some of their scariness. I find that decorators can often be applied when you need</p>
<ul>
<li>code that runs before and after each invocation of a function (like <code>timed</code>)</li>
<li>some metadata you want to store along with a function (like the lookup table in <code>memoized</code>)</li>
<li>registering a function in a table (like Flask and Tube's <code>app.route</code>)</li>
<li>permission-checking (like Django's <code>login_required</code>, which we didn't talk about)</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="ipynb-input">
<div class="prompt input_prompt">
In []:
</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight"><pre> 
</pre></div>
</div>
</div>
</div>
</div>
</div>

